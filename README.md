# API для меню ресторана

Проект представляет собой API по работе с меню ресторана, все CRUD операции. Написан на фреймворке FastAPI
с использованием PostgreSQL в качестве основной БД и Redis для кэширования.

## Оглавление
1. [Описание](#Описание)
2. [Инструменты](#Инструменты)
3. [Сборка](#Сборка)
   1. [Prod](#Prod)
   2. [Test](#Test)
   3. [Dev](#Dev)
      1. [Pre-commit хуки](#Pre-commit_хуки)
4. [Postman-тесты](#Postman-тесты)

5. <a name="твоё_название">Текст ссылки</a> 

## Описание

Даны 3 сущности: Меню, Подменю, Блюдо.

**Зависимости**:
* У меню есть подменю, которые к ней привязаны.
* У подменю есть блюда.

**Условия**:
* Блюдо не может быть привязано напрямую к меню, минуя подменю.
* Блюдо не может находиться в 2-х подменю одновременно.
* Подменю не может находиться в 2-х меню одновременно.
* Если удалить меню, должны удалиться все подменю и блюда этого меню.
* Если удалить подменю, должны удалиться все блюда этого подменю.
* Цены блюд выводить с округлением до 2 знаков после запятой.
* Во время выдачи списка меню, для каждого меню добавлять кол-во подменю и блюд в этом меню.
* Во время выдачи списка подменю, для каждого подменю добавлять кол-во блюд в этом подменю.

## Инструменты
* **Python** (3.10);
* **FastAPI** (asynchronous Web Framework);
* **PostgreSQL** (database);
* **SQLAlchemy** (working with database from Python);
* **Alembic** (database migrations made easy);
* **Pydantic** (data verification);
* **Redis** (caching);
* **Pytest** (tests);
* **Docker Compose**.

## Сборка

1. Скачиваем содержимое репозитория в отдельную папку:
    ```
    git clone https://github.com/FreemaHG/dishesApiProject.git
    ```

### Prod

2. Переименовываем файл "**.env.prod.template**" в "**.env**".


3. Собираем и запускаем контейнеры с API, PostgreSQL и Redis:
   ```
   docker-compose up -d
   ```

   После сборки и запуска приложения ознакомиться с документацией API можно по адресу:
    ```
    http://127.0.0.1:8000/docs/
    ```

4. Остановка и удаление контейнеров:
   ```
   docker-compose down
   ```

### Test

2. Собираем контейнеры и запускаем тесты:
   ```
   docker-compose -f docker-compose-tests.yml up -d && docker logs -t -f test_api && docker-compose down
   ```

   **Примечание**: в приложении реализована функция аналог reverse() в Django (см. src/utils/reverse).
   Функция используется в тесте - tests/unit/test_reverse.py


   Проверка:
      ```
      pytest -v tests/unit/test_reverse.py::TestReverse
      ```

### Dev

2. Переименовываем файл "**.env.dev.template**" в "**.env**", при необходимости можно задать свои параметры.


3. Создаем и активируем виртуальное окружение:
   ```
   python3 -m venv venv
   ```
   ```
   source venc/bin/activate
   ```

4. Устанавливаем зависимости:
   ```
   pip install -r requirements/dev.txt
   ```

5. Собираем и запускаем контейнеры с PostgreSQL и Redis:
   ```
   docker-compose up -d postgres redis
   ```

6. Применяем миграции (создаем структуру БД):
   ```
   alembic upgrade head
   ```

7. Очищаем Redis (на всякий случай от остаточных данных):
   ```
   redis-cli flushall
   ```

8. Запускаем сервер:
   ```
   uvicorn src.main:app --reload
   ```

9. Остановка и удаление контейнеров с PostgreSQL и Redis:
   ```
   docker-compose down postgres redis
   ```

#### Pre-commit хуки

В проекте используются Git-хуки для автоматической проверки и форматирования кода перед созданием коммита.

**ВАЖНО**: на локальной машине разработчика должен быть установлен пакет **pre-commit**

Применяемые хуки описаны в корне проекта в файле .pre-commit-config.yaml

Для активации хуков вводим:
   ```
   pre-commit install
   ```
Предварительная проверка и форматирование кода:
   ```
   pre-commit run --all-files
   ```

## Postman-тесты

1. Запускаем приложение в режиме Dev либо Prod (см. шаги выше).

**ВАЖНО**: Во время запуска тестового сценария БД должна быть **пуста**!

В postman в левом верхнем углу нажимаем "import":
![](/postman/1.png)

Перетаскиваем во всплывшее окно два файла (коллекция тестов и переменные окружения) из папки postman
в корне проекта. Подтверждаем импорт:
![](/postman/2.png)

Либо слева во вкладке "Environments" кликаем галочку рядом с переменными окружения.
Либо справа сверху в выпадающем списке выбираем загруженные переменные окружения.
![](/postman/3.png)

Далее кликаем: слева во вкладке "Collections" -> три точки на папке "Тестовый сценарий" -> "Run folder"
![](/postman/4.png)

Для запусков тестов нажимаем "Run Menu app"
![](/postman/5.png)

Радуемся успешно пройденным тестам.
![](/postman/6.png)


[Текст ссылки](#твоё_название)
